---
title: "Performing Principal Component Analysis in R"
author: "Liezel Tamon"
date: "2023-05-05"
output:
  slidy_presentation:
    incremental: yes
    widescreen: yes
    smaller: yes
    css: custom.css
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, collapse = FALSE, class.source="code_format", class.output="output_format")
```

## I. Studying real-world systems often involve complex data with many dimensions or features {.build}

## I. Studying real-world systems often involve complex data with many dimensions or features {.build}

- Problem - Interpretability

  - Hard to extract meaningful relationships between many features 
  - Hard to visualise

- Solution - Reduce dimensionality (number of features) 

  - Select a few from existing / original features
  - Combine original features into fewer new ones
  
## II. Principal Component Analysis (PCA) {.build}

- Combines original features to form new ones, principal components (PCs)
- Strives to capture the most information or variation in the data in the least number of PCs

## III. Performing PCA in R 

1. Apply PCA using R base function prcomp() 
2. Determine the proportion of variation in the data accounted for by the PCs 
3. Make PCA plot 
4. Examine contribution of original features to PCs (i.e. to data) using PC loading values

---

```{r generate dummy dataset, include=FALSE}

# Generate empty data table

data.df <- matrix(nrow=12, ncol=5)

row.len <- nrow(data.df)
col.len <- ncol(data.df)

colnames(data.df) <- paste("Gene", 1:ncol(data.df), sep="")
rownames(data.df) <- paste("Cell", 1:nrow(data.df), sep="")

# Populate each row with fake data

for (col in 1:col.len) {
  
  clust1 <- rpois(5, lambda=sample(x=10:1000, size=1))
  clust2 <- rpois(5, lambda=sample(x=10:1000, size=1))
  clust3 <- rpois(2, lambda=sample(x=10:1000, size=1))

  data.df[,col] <- c(clust1, clust2, clust3)
  
}

data.df <- cbind(data.df, Gene6=rpois(12, lambda=sample(x=10:12, size=1)))
#

write.csv(data.df, file=paste0("./data/data.csv"), row.names=TRUE)

```

### 1. Apply PCA using R base function prcomp()

#### a. Load dataset {.nobr}

-
  ```{r load dataset}
  
  data.df <- read.csv(file=paste0("./data/data.csv"),
                      row.names=1)
  
  ```
  
<!-- Check how many features and observations -->

-
  ```{r str dataset}
  
  str(data.df)
  
  ```

---
  
### 1. Apply PCA using R base function prcomp()

#### b. Check dataset {.nobr}

<!-- Confirm that observations (cells) are rows, features (genes) are columns -->

-
  ```{r head dataset}
  
  head(data.df)
  
  ```

-
  ```{r missing values}
  
  any(is.na(data.df))
  
  ```

-
  ```{r numeric rows}

  is.row.numeric <- sapply(X=data.df, 
                           FUN=is.numeric)
  
  ```
  
  ```{r all numeric}
  
  all(is.row.numeric)
    
  ```

---

### 1. Apply PCA using R base function prcomp()

#### c. PCA using prcomp() {.nobr}

-
  ```{r prcomp}
  
  pca.out <- prcomp(x=data.df, 
                    center=TRUE,  
                    scale=TRUE) 
                    
  ```
  
- 
  ```{r view PCs}
  
  head(pca.out$x)
  
  ```
  
- 
  ```{r view sdev}
  
  head(pca.out$sdev)
  
  ```

---

### 2. Calculate proportion of variation accounted for by each PC

- 
  ```{r calc var}
  
  pc.var        <- (pca.out$sdev)^2
  names(pc.var) <- paste("PC", 1:length(pc.var), sep="")
  pc.var 
  
  ```

- 
  ```{r perc var}
  
  pc.var.sum  <- sum(pc.var)
  pc.var.perc <- pc.var / pc.var.sum * 100
  pc.var.perc <- round(pc.var.perc, digits=4)
  pc.var.perc
  
  ```

---

### 2. Calculate proportion of variation accounted for by each PC

- 
  ```{r scree plot, fig.width=7, fig.height=5}
  
  plot(pc.var.perc, 
       type="b",
       main="Scree plot", 
       ylab="Percentage variation", 
       xlab="Principal Component"
       )
 
  ```

---

### 3. Make PCA plot using base graphics

- 
  ```{r pca plot, fig.width=7, fig.height=5}
  
  plot(x=pca.out$x[,"PC1"], 
       y=pca.out$x[,"PC2"],
       main="PCA plot",
       ylab=paste("PC2", pc.var.perc[["PC2"]], "%", sep=" "),
       xlab=paste("PC1", pc.var.perc[["PC1"]], "%", sep=" ")
       )
   abline(v=0, lty="dashed")
   abline(h=0, lty="dashed")

  ```

---

### 4. Examine contribution of original features to PCs with PC loading values

```{r loadings df}
  
  library(ggplot2)
  
  loadings.df <- as.data.frame(pca.out$rotation)
  loadings.df$geneName <- rownames(loadings.df)

  head(loadings.df)
  
```

---

### 4. Examine contribution of original features to PCs with PC loading values

-
  ```{r loadings plot}
    
    ggplot(data=loadings.df, aes(x=PC1, y=PC2)) +
      geom_point(size=2.5, col="darkred") +
      geom_text(aes(label=geneName), vjust=1.5, hjust=0.5, col="darkred") + 
      geom_hline(yintercept=0, lty="dashed") +
      geom_vline(xintercept=0, lty="dashed") +
      labs(title="PCA loadings plot",
           y=paste("PC2", pc.var.perc[["PC2"]], "%", sep=" "),
           x=paste("PC1", pc.var.perc[["PC1"]], "%", sep=" ")) + 
      theme_classic()
    
  ```
---

### 4. Examine contribution of original features to PCs with PC loading values

-
  ```{r biplot base, echo=TRUE, eval=FALSE}
    biplot(pca.out)
  ```
  
-
  ```{r biplot ggplot}
  
    library(factoextra)
  
    fviz_pca_biplot(pca.out, col.var = "darkred",) + 
      labs(title="PCA biplot",
           y=paste("PC2", pc.var.perc[["PC2"]], "%", sep=" "),
           x=paste("PC1", pc.var.perc[["PC1"]], "%", sep=" ")) + 
      theme_classic()
    
  ```

---

## IV. Points to remember

- Preprocessing of data
- Applicability of PCA to data
- Applications of PCA
  - Trends
  - Clusters
  - Outliers
- Limitations of PCA
  - PCs are linear combinations of original features
- Using extra packages
  